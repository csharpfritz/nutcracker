@page "/"
@using Nutcracker.Services
@inject LightshowService LightshowService
@inject LedService LedService
@implements IDisposable
@rendermode InteractiveServer

<PageTitle>🎄 Nutcracker Holiday Display</PageTitle>

<div class="christmas-container">
    <div class="christmas-header">
        <h1 class="christmas-title">🎄 Nutcracker Holiday Display 🎅</h1>
        <p class="christmas-subtitle">Bringing Holiday Cheer with Music & Lights!</p>
        <button class="btn-settings" @onclick="ToggleSettings">⚙️ Settings</button>
    </div>

    <!-- Settings Section (collapsible) -->
    @if (showSettings)
    {
        <div class="settings-section">
            <h3>⚙️ Settings</h3>
            <button class="btn-test" @onclick="TestLeds">🔦 Test LEDs</button>
        </div>
    }

    <!-- Now Playing Section -->
    <div class="now-playing-section">
        <h2 class="section-title">🎵 Now Playing</h2>
        @if (LightshowService.CurrentLightshow != null)
        {
            <div class="now-playing-card">
                <div class="now-playing-icon">🎶</div>
                <div class="now-playing-info">
                    <h3>@LightshowService.CurrentLightshow.Name</h3>
                    <p class="song-duration">Duration: @FormatDuration(LightshowService.CurrentLightshow.Duration)</p>
                </div>
                <div class="playing-animation">
                    <span></span>
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
            <div class="volume-control">
                <label for="volume-slider">🔊 Volume</label>
                <input type="range" 
                       id="volume-slider" 
                       min="0" 
                       max="100" 
                       @bind="volume" 
                       @bind:event="oninput"
                       @onchange="UpdateVolume" />
                <span class="volume-value">@volume%</span>
            </div>
            <div class="brightness-control">
                <label for="brightness-slider">💡 LED Brightness</label>
                <input type="range" 
                       id="brightness-slider" 
                       min="0" 
                       max="100" 
                       @bind="brightness" 
                       @bind:event="oninput"
                       @onchange="UpdateBrightness" />
                <span class="brightness-value">@brightness%</span>
            </div>
            <div class="control-buttons">
                <button class="btn-skip" @onclick="SkipCurrentShow">⏭️ Skip</button>
            </div>
        }
        else
        {
            <div class="no-playing-card">
                <p>❄️ No song currently playing</p>
            </div>
        }
    </div>

    <!-- Queue Section -->
    <div class="queue-section">
        <h2 class="section-title">📋 Up Next</h2>
        @if (queueList.Any())
        {
            <div class="queue-list">
                @foreach (var (show, index) in queueList.Select((s, i) => (s, i)))
                {
                    <div class="queue-item">
                        <span class="queue-number">@(index + 1)</span>
                        <div class="queue-info">
                            <strong>@show.Name</strong>
                            <span class="queue-duration">@FormatDuration(show.Duration)</span>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="empty-queue">
                <p>🎁 Queue is empty - Add some songs below!</p>
            </div>
        }
    </div>

    <!-- Available Songs Section -->
    <div class="available-songs-section">
        <h2 class="section-title">🎼 Available Songs</h2>
        <div class="songs-grid">
            @foreach (var show in LightshowService.AvailableLightshows)
            {
                <div class="song-card">
                    <div class="song-icon">🎵</div>
                    <div class="song-info">
                        <h4>@show.Name</h4>
                        <p class="song-duration">@FormatDuration(show.Duration)</p>
                    </div>
                    <button class="btn-add" @onclick="() => AddToQueue(show)">Add to Queue</button>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private List<LightshowSettings> queueList = new();
    private bool showSettings = false;
    private int volume = 70; // Default volume at 70%
    private int brightness = 80; // Default brightness at 80%

    protected override void OnInitialized()
    {
        RefreshQueue();
        
        // Subscribe to service events
        LightshowService.LightshowStarted += OnLightshowChanged;
        LightshowService.LightshowEnded += OnLightshowChanged;
        LightshowService.QueueChanged += OnLightshowChanged;
    }

    private async void OnLightshowChanged(object? sender, EventArgs e)
    {
        RefreshQueue();
        await InvokeAsync(StateHasChanged);
    }

    private void RefreshQueue()
    {
        queueList = LightshowService.LightshowQueue.ToList();
    }

    private void AddToQueue(LightshowSettings show)
    {
        LightshowService.EnqueueLightshow(show);
    }

    private void SkipCurrentShow()
    {
        LightshowService.SkipCurrentShow();
    }

    private void ToggleSettings()
    {
        showSettings = !showSettings;
    }

    private void UpdateVolume()
    {
        LightshowService.SetVolume(volume);
    }

    private void UpdateBrightness()
    {
        LedService.SetBrightness(brightness);
    }

    private async Task TestLeds()
    {
        try
        {
            Console.WriteLine("TestLeds button clicked - starting test...");
            await LedService.TestLeds();
            Console.WriteLine("TestLeds completed successfully");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"TestLeds failed: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
        }
    }

    private string FormatDuration(TimeSpan duration)
    {
        return $"{duration.Minutes}:{duration.Seconds:D2}";
    }

    public void Dispose()
    {
        // Unsubscribe from events
        LightshowService.LightshowStarted -= OnLightshowChanged;
        LightshowService.LightshowEnded -= OnLightshowChanged;
        LightshowService.QueueChanged -= OnLightshowChanged;
    }
}
